<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pelican Live Discovery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/oidc-client/1.11.5/oidc-client.min.js"></script>
    <style>
        body { background: #068bd3; color: #fff; text-align: center; padding-top: 50px; font-family: sans-serif; }
        .hidden { display: none; }
        #dashboard { border: 1px solid #444; padding: 30px; margin: 20px auto; max-width: 900px; background: #111; text-align: left; border-radius: 8px; }
        
        .discovery-item { 
            background: #222222; border-left: 4px solid #036c9d; padding: 15px; margin: 10px 0; border-radius: 4px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; transition: 0.2s; 
        }
        .discovery-item:hover { background: #2a2a2a; border-left-color: #00ff00; }
        
        button { padding: 12px 24px; cursor: pointer; font-weight: bold; background: #fff; border: none; border-radius: 4px; color: #000; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-spotlight, .btn-back { background: #036c9d; color: #fff; margin-right: 10px; }
        
        .system-online { color: #036c9d; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 14px; text-transform: uppercase; }
        .return-box { padding: 6px 12px; border-radius: 4px; font-weight: bold; font-family: monospace; min-width: 90px; text-align: center; border: 1px solid; }
        #search-bar { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; }

        /* SHIMMER EFFECT */
        .shimmer {
            background: linear-gradient(90deg, #1a1a1a 25%, #333 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            height: 80px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-card { background: #1a1a1a; padding: 15px; border-radius: 4px; border: 1px solid #333; }
        .stat-label { color: #888; font-size: 11px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .stat-value { font-size: 18px; font-weight: bold; color: #00ff00; }
    </style>
</head>
<body>

    <div id="login-section">
        <h1>Pelican Secure Gateway</h1>
        <button type="button" onclick="startLogin()">LOGIN TO PELICAN</button>
    </div>

    <div id="dashboard" class="hidden">
        <div class="system-online">● SYSTEM ONLINE: SUCCESSFUL LOGIN</div>
        <h1 id="feed-title">Pelican Signals</h1>
        
        <div id="nav-controls" style="margin-bottom: 15px;">
            <button class="btn-spotlight" onclick="fetchSpotlight()">PELICAN SPOTLIGHT</button>
            <button class="btn-back" onclick="loadInitialFeed()">BEST SIGNALS IN JAN</button>
        </div>

        <input type="text" id="search-bar" placeholder="Search signals by name..." onkeyup="filterSignals()">

        <div id="discovery-list"></div>
        
        <hr style="border: 0; border-top: 1px solid #333; margin: 20px 0;">
        <button onclick="logout()">LOGOUT</button>
    </div>

    <script>
        const settings = {
            authority: 'https://identity.copy-trade.io',
            client_id: 'api-client',
            // --- UPDATED FOR GITHUB ---
            redirect_uri: 'https://dejan-djurdjevic-pelican.github.io/Pelican-Discovery/', 
            response_type: 'code',
            scope: 'openid profile email copytrade',
            acr_values: 'tenant:pelican',
            metadata: {
                issuer: 'https://identity.copy-trade.io',
                authorization_endpoint: 'https://identity.copy-trade.io/connect/authorize',
                token_endpoint: 'https://identity.copy-trade.io/connect/token',
                jwks_uri: 'https://identity.copy-trade.io/.well-known/openid-configuration/jwks',
                userinfo_endpoint: 'https://identity.copy-trade.io/connect/userinfo' 
            },
            userStore: new Oidc.WebStorageStateStore({ store: window.localStorage })
        };

        const mgr = new Oidc.UserManager(settings);

        function startLogin() { mgr.signinRedirect(); }

        if (window.location.search.includes("code=")) {
            mgr.signinRedirectCallback().then(function(user) {
                window.history.replaceState({}, document.title, window.location.pathname);
                document.getElementById("login-section").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                fetchTopMonthly(user.access_token);
            }).catch(console.error);
        }

        function showShimmer(count = 5) {
            const list = document.getElementById("discovery-list");
            list.innerHTML = "";
            for (let i = 0; i < count; i++) {
                const div = document.createElement('div');
                div.className = 'shimmer';
                list.appendChild(div);
            }
        }

        async function loadInitialFeed() {
            document.getElementById("nav-controls").style.display = "block";
            document.getElementById("search-bar").style.display = "block";
            const user = await mgr.getUser();
            document.getElementById("feed-title").innerText = "Pelican's best performing signals in January";
            document.getElementById("search-bar").value = "";
            fetchTopMonthly(user.access_token);
        }

        async function fetchTopMonthly(token) {
            showShimmer(10);
            try {
                const response = await fetch('https://papi.copy-trade.io/api/discover/CopiersProfitMonth', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                document.getElementById("discovery-list").innerHTML = "";
                const allItems = Array.isArray(data) ? data : (data[0]?.Items || []);
                allItems.slice(0, 10).forEach(item => renderSpotlightItem(item));
            } catch (err) {
                document.getElementById("discovery-list").innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

        async function fetchSpotlight() {
            const title = document.getElementById("feed-title");
            title.innerText = "Pelican Spotlight Signals";
            document.getElementById("search-bar").value = "";
            showShimmer(5);
            const user = await mgr.getUser();
            try {
                const response = await fetch('https://papi.copy-trade.io/api/discover/Strategies', {
                    headers: { 'Authorization': `Bearer ${user.access_token}` }
                });
                const data = await response.json();
                document.getElementById("discovery-list").innerHTML = "";
                const items = Array.isArray(data) ? data : (data[0]?.Items || []);
                items.forEach(item => renderSpotlightItem(item));
            } catch (err) {
                document.getElementById("discovery-list").innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

        function renderSpotlightItem(item) {
            const list = document.getElementById("discovery-list");
            const s = item.Strategy;
            let rawValue = parseFloat(item.Value || 0);
            if (item.Measure === "Percent" || rawValue < 2) { rawValue = rawValue * 100; }
            const displayValue = rawValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const imageUrl = `https://assets.copy-trade.io/images/strategies/thumbnails/${s.Id}`;
            const isCurrency = item.Measure === "Currency";

            const div = document.createElement('div');
            div.className = 'discovery-item';
            div.onclick = () => fetchSPDetails(s.Id, s.Name);
            div.innerHTML = `
                <div style="display: flex; align-items: center; text-align: left;">
                    <img src="${imageUrl}" onerror="this.onerror=null; this.src='https://www.gravatar.com/avatar/00000000000000000000000000000000?d=mp&f=y';" 
                         style="width: 50px; height: 50px; border-radius: 4px; margin-right: 15px; border: 1px solid #333; object-fit: cover; background: #222;">
                    <div style="display: flex; flex-direction: column;">
                        <strong style="color: #fff; font-size: 18px; margin-bottom: 4px;">${s.Name}</strong>
                        <span style="color: #888; font-size: 12px;">Copiers: ${s.NumCopiers} | Rank: #${item.Rank}</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="return-box" style="color: #00ff00; border-color: #00ff00;">
                        ${isCurrency ? '$' : ''}${displayValue}${isCurrency ? '' : '%'}
                    </div>
                    <div style="font-size: 10px; color: #555; margin-top: 4px; text-transform: uppercase;">${isCurrency ? 'USD' : item.Measure}</div>
                </div>`;
            list.appendChild(div);
        }

        async function fetchSPDetails(id, name) {
            const list = document.getElementById("discovery-list");
            const title = document.getElementById("feed-title");
            const user = await mgr.getUser();
            document.getElementById("nav-controls").style.display = "none";
            document.getElementById("search-bar").style.display = "none";
            title.innerText = `${name} Analysis`;
            showShimmer(3);
            try {
                const res = await fetch(`https://papi.copy-trade.io/api/strategies/${id}/stats`, {
                    headers: { 'Authorization': `Bearer ${user.access_token}` }
                });
                const stats = await res.json();
                const trades = stats.Trades.Inception;
                const prof = stats.Profitability.Inception;
                const status = stats.Status;

                const winRate = trades.Total > 0 ? ((trades.Wins / trades.Total) * 100).toFixed(2) : "0.00";
                const realisedReturn = (prof.RealisedReturn * 100).toFixed(2);
                const maxDD = (Math.abs(prof.MaxDrawdown) * 100).toFixed(2);
                const liveReturn = prof.History.length > 0 ? (prof.History[prof.History.length - 1].AccountReturn * 100).toFixed(2) : "0.00";

                list.innerHTML = `
                    <div style="background: #222; padding: 25px; border-radius: 8px; border: 1px solid #036c9d; text-align: left;">
                        <button onclick="loadInitialFeed()" style="margin-bottom: 20px; background: #444; color: #fff;">← BACK TO FEED</button>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;">
                            <div><span style="color: #888; font-size: 11px; text-transform: uppercase;">Realised PnL</span><div style="font-size: 20px; font-weight: bold; color: #00ff00;">$${prof.RealisedPnl.toLocaleString()}</div></div>
                            <div><span style="color: #888; font-size: 11px; text-transform: uppercase;">Unrealised PnL</span><div style="font-size: 20px; font-weight: bold; color: ${prof.UnrealisedPnl >= 0 ? '#00ff00' : '#ff4444'};">$${prof.UnrealisedPnl.toLocaleString()}</div></div>
                            <div style="text-align: right;"><span style="color: #888; font-size: 11px; text-transform: uppercase;">Current Balance</span><div style="font-size: 20px; font-weight: bold; color: #fff;">$${status.Balance.toLocaleString()}</div></div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card"><span class="stat-label">Live Return</span><span class="stat-value" style="color: #00ff00;">${liveReturn}%</span></div>
                            <div class="stat-card"><span class="stat-label">Realised Return</span><span class="stat-value">${realisedReturn}%</span></div>
                            <div class="stat-card"><span class="stat-label">Max Drawdown</span><span class="stat-value" style="color: #ff4444;">-${maxDD}%</span></div>
                            <div class="stat-card"><span class="stat-label">Win Rate</span><span class="stat-value" style="color: #fff;">${winRate}%</span></div>
                        </div>
                        <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr; margin-top: 15px;">
                            <div class="stat-card" style="border-color: #444;"><span class="stat-label">Leverage</span><span class="stat-value" style="font-size: 14px; color: #aaa;">1:${status.Leverage}</span></div>
                            <div class="stat-card" style="border-color: #444;"><span class="stat-label">Credit</span><span class="stat-value" style="font-size: 14px; color: #aaa;">$${status.Credit.toLocaleString()}</span></div>
                            <div class="stat-card" style="border-color: #444;"><span class="stat-label">Total Trades</span><span class="stat-value" style="font-size: 14px; color: #aaa;">${trades.Total}</span></div>
                        </div>
                    </div>`;
            } catch (err) {
                list.innerHTML = `<p style="color:red;">Error fetching stats: ${err.message}</p>`;
            }
        }

        function filterSignals() {
            const input = document.getElementById('search-bar').value.toLowerCase();
            const items = document.getElementsByClassName('discovery-item');
            for (let i = 0; i < items.length; i++) {
                const name = items[i].getElementsByTagName("strong")[0].innerText.toLowerCase();
                items[i].style.display = name.includes(input) ? "flex" : "none";
            }
        }

        function logout() {
            window.localStorage.clear();
            window.location.href = settings.redirect_uri;
        }
    </script>
</body>
</html>
